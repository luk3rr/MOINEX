name: Build Windows Installer

on:
  release:
    types: [created]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows-installer:
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Generate Windows icon
        run: |
          choco install imagemagick -y
          magick docs/img/icons/moinex-icon-256.png -define icon:auto-resize=256,128,64,48,32,16 docs/img/icons/moinex-icon.ico
        shell: pwsh
      
      - name: Setup Python embedded
        run: |
          .\scripts\setup-python-embedded.bat
        shell: cmd
      
      - name: Build Windows installer
        run: |
          .\scripts\build-windows-installer.bat
        shell: cmd
      
      - name: Get version from pom.xml
        id: get_version
        run: |
          $version = Select-Xml -Path "pom.xml" -XPath "/*[local-name()='project']/*[local-name()='version']/text()" | Select-Object -ExpandProperty Node | Select-Object -ExpandProperty Value
          if ([string]::IsNullOrEmpty($version)) {
            $version = "1.0.0"
          }
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        shell: pwsh
      
      - name: Find installer file
        id: find_installer
        run: |
          $installer = Get-ChildItem -Path "installer-output" -Filter "*.exe" | Select-Object -First 1
          if ($installer) {
            echo "INSTALLER_PATH=$($installer.FullName)" >> $env:GITHUB_OUTPUT
            echo "INSTALLER_NAME=$($installer.Name)" >> $env:GITHUB_OUTPUT
          } else {
            echo "Installer not found!"
            exit 1
          }
        shell: pwsh
      
      - name: Upload installer as artifact
        uses: actions/upload-artifact@v4
        with:
          name: moinex-windows-installer
          path: ${{ steps.find_installer.outputs.INSTALLER_PATH }}
          retention-days: 90
      
      - name: Upload installer to release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.find_installer.outputs.INSTALLER_PATH }}
